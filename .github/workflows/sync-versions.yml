name: üîÑ Auto-Sync Versions

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ v5-full –≤–æ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏

on:
  push:
    branches:
      - main
      - master
      - 'claude/**'
    paths:
      # –¢—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ v5-full
      - 'mobile-app-versions/v5-full/**'
      - 'mobile-app-sandboxes/hybrid-best-of-both/**'

  workflow_dispatch:
    inputs:
      source:
        description: 'Source version (v5-full, hybrid, current)'
        required: true
        default: 'v5-full'
      component:
        description: 'Component to sync (all, gradle, backend, flutter)'
        required: true
        default: 'all'
      dry_run:
        description: 'Dry run (preview only)'
        type: boolean
        default: false

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  check-changes:
    name: üîç Check what changed
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.check.outputs.should_sync }}
      changed_files: ${{ steps.check.outputs.changed_files }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check changed files
        id: check
        run: |
          # –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω—É–∂–Ω–∞ –ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
          if echo "$CHANGED_FILES" | grep -q "mobile-app-versions/v5-full/\|mobile-app-sandboxes/hybrid-best-of-both/"; then
            echo "should_sync=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected in v5-full or hybrid - sync needed"
          else
            echo "should_sync=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No changes in v5-full or hybrid - skipping sync"
          fi

  sync-versions:
    name: üîÑ Sync to all versions
    needs: check-changes
    if: needs.check-changes.outputs.should_sync == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Make sync script executable
        run: chmod +x sync-versions.sh check-consistency.sh

      - name: Check current consistency
        run: |
          echo "üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–µ—Ä—Å–∏–π:"
          ./check-consistency.sh || true

      - name: Determine source and component
        id: params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "source=${{ github.event.inputs.source }}" >> $GITHUB_OUTPUT
            echo "component=${{ github.event.inputs.component }}" >> $GITHUB_OUTPUT
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          else
            echo "source=v5-full" >> $GITHUB_OUTPUT
            echo "component=all" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync backend components
        if: steps.params.outputs.component == 'all' || steps.params.outputs.component == 'backend'
        run: |
          if [ "${{ steps.params.outputs.dry_run }}" = "true" ]; then
            ./sync-versions.sh backend ${{ steps.params.outputs.source }} --dry-run
          else
            ./sync-versions.sh backend ${{ steps.params.outputs.source }} --force
          fi

      - name: Sync Gradle components
        if: steps.params.outputs.component == 'all' || steps.params.outputs.component == 'gradle'
        run: |
          if [ "${{ steps.params.outputs.dry_run }}" = "true" ]; then
            ./sync-versions.sh gradle ${{ steps.params.outputs.source }} --dry-run
          else
            ./sync-versions.sh gradle ${{ steps.params.outputs.source }} --force
          fi

      - name: Sync Flutter components
        if: steps.params.outputs.component == 'all' || steps.params.outputs.component == 'flutter'
        run: |
          if [ "${{ steps.params.outputs.dry_run }}" = "true" ]; then
            ./sync-versions.sh flutter ${{ steps.params.outputs.source }} --dry-run
          else
            ./sync-versions.sh flutter ${{ steps.params.outputs.source }} --force
          fi

      - name: Sync Android resources
        if: steps.params.outputs.component == 'all'
        run: |
          if [ "${{ steps.params.outputs.dry_run }}" = "true" ]; then
            ./sync-versions.sh android_res ${{ steps.params.outputs.source }} --dry-run
          else
            ./sync-versions.sh android_res ${{ steps.params.outputs.source }} --force
          fi

      - name: Check consistency after sync
        run: |
          echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:"
          ./check-consistency.sh

      - name: Commit changes
        if: steps.params.outputs.dry_run == 'false'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add mobile-app-versions/
            git commit -m "üîÑ Auto-sync: ${{ steps.params.outputs.component }} from ${{ steps.params.outputs.source }} to all versions

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- –ò—Å—Ç–æ—á–Ω–∏–∫: ${{ steps.params.outputs.source }}
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: ${{ steps.params.outputs.component }}
- –¶–µ–ª–µ–≤—ã–µ –≤–µ—Ä—Å–∏–∏: v1-v7

–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ:
${{ needs.check-changes.outputs.changed_files }}

–¢—Ä–∏–≥–≥–µ—Ä: ${{ github.event_name }}
Commit: ${{ github.sha }}"

            git push
            echo "‚úÖ Changes committed and pushed"
          else
            echo "‚è≠Ô∏è  No changes to commit"
          fi

  summary:
    name: üìä Summary
    needs: [check-changes, sync-versions]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Print summary
        run: |
          echo "## üîÑ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Should sync:** ${{ needs.check-changes.outputs.should_sync }}" >> $GITHUB_STEP_SUMMARY
          echo "**Sync result:** ${{ needs.sync-versions.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.sync-versions.result }}" = "success" ]; then
            echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.sync-versions.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è  –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª–∞—Å—å" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π" >> $GITHUB_STEP_SUMMARY
          fi
