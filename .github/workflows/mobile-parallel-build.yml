name: üîÑ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ Mobile (LITE + FULL)

on:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–∏ push –≤ –≤–µ—Ç–∫–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
  push:
    branches:
      - main
      - master
      - 'claude/**'
    paths:
      - 'mobile-app/**'
      - 'mobile-app-lite/**'
      - '.github/workflows/mobile-parallel-build.yml'

  # –°–±–æ—Ä–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ release
  release:
    types: [created, published]

  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI
  workflow_dispatch:
    inputs:
      version:
        description: '–í–µ—Ä—Å–∏—è APK (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.0.0)'
        required: false
        default: 'dev'
      build_full:
        description: '–°–æ–±—Ä–∞—Ç—å –ü–û–õ–ù–£–Æ –≤–µ—Ä—Å–∏—é?'
        required: false
        type: boolean
        default: true
      build_lite:
        description: '–°–æ–±—Ä–∞—Ç—å –û–ë–õ–ï–ì–ß–Å–ù–ù–£–Æ –≤–µ—Ä—Å–∏—é?'
        required: false
        type: boolean
        default: true

env:
  FLUTTER_VERSION: '3.16.0'
  JAVA_VERSION: '17'
  PYTHON_VERSION: '3.9'

jobs:
  # ========================================
  # JOB 1: –û–ë–õ–ï–ì–ß–Å–ù–ù–ê–Ø –í–ï–†–°–ò–Ø (LITE)
  # ========================================
  build-lite:
    name: üöÄ –°–±–æ—Ä–∫–∞ LITE –≤–µ—Ä—Å–∏–∏ (~80-90 MB)
    runs-on: ubuntu-latest
    # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –æ—Ç–∫–ª—é—á–∏–ª lite —Å–±–æ—Ä–∫—É
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.build_lite == 'true' }}

    steps:
      - name: üì• Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ü¶ã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (LITE)
        continue-on-error: true
        run: |
          echo "========================================="
          echo "üöÄ –û–ë–õ–ï–ì–ß–Å–ù–ù–ê–Ø –í–ï–†–°–ò–Ø - –°–±–æ—Ä–∫–∞"
          echo "========================================="
          echo "Java:    $(java -version 2>&1 | head -n 1)"
          echo "Flutter: $(flutter --version 2>&1 | head -n 1)"
          echo "Python:  $(python3 --version)"
          echo "Branch:  $(git branch --show-current)"
          echo "Commit:  $(git rev-parse --short HEAD)"
          echo "========================================="

      - name: üìù –°–æ–∑–¥–∞–Ω–∏–µ local.properties –¥–ª—è Android
        run: |
          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ Flutter SDK
          if [ -n "$FLUTTER_HOME" ]; then
            FLUTTER_ROOT="$FLUTTER_HOME"
          elif command -v flutter &> /dev/null; then
            FLUTTER_ROOT=$(dirname "$(dirname "$(which flutter)")")
          else
            echo "‚ùå –û–®–ò–ë–ö–ê: Flutter SDK –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi

          echo "Flutter SDK: $FLUTTER_ROOT"
          echo "flutter.sdk=$FLUTTER_ROOT" > mobile-app-lite/android/local.properties

          echo "‚úÖ local.properties —Å–æ–∑–¥–∞–Ω"
          cat mobile-app-lite/android/local.properties

      - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (LITE)
        run: |
          cd mobile-app-lite
          echo "üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è LITE..."
          flutter pub get --verbose

          if [ ! -f pubspec.lock ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: pubspec.lock –Ω–µ —Å–æ–∑–¥–∞–Ω"
            exit 1
          fi

          echo "‚úÖ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Flutter –ø—Ä–æ–µ–∫—Ç–∞ (LITE)
        continue-on-error: true
        run: |
          cd mobile-app-lite
          echo "üîç Flutter Doctor (LITE):"
          flutter doctor -v
          echo ""
          echo "Flutter Analyze (LITE):"
          flutter analyze --no-fatal-infos

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–∏ APK (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–ª—é—á–∏)
      - name: üîê –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ keystore (LITE)
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        if: env.KEYSTORE_BASE64 != ''
        run: |
          echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è LITE APK..."
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > mobile-app-lite/android/data20-release-key.jks
          echo "‚úÖ Keystore –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω"

      - name: üîë –°–æ–∑–¥–∞–Ω–∏–µ key.properties (LITE)
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        if: env.KEYSTORE_BASE64 != ''
        run: |
          cat > mobile-app-lite/android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=data20-release-key.jks
          EOF
          echo "‚úÖ key.properties —Å–æ–∑–¥–∞–Ω"

      # –°–±–æ—Ä–∫–∞ LITE APK
      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ LITE APK (Debug)
        id: build_lite_apk
        run: |
          cd mobile-app-lite
          echo "========================================="
          echo "üöÄ –°–±–æ—Ä–∫–∞ –û–ë–õ–ï–ì–ß–Å–ù–ù–û–ô –≤–µ—Ä—Å–∏–∏ APK"
          echo "========================================="

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
          declare -a CHECK_FILES=(
            "pubspec.yaml"
            "android/app/build.gradle"
            "android/local.properties"
          )

          for file in "${CHECK_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
              exit 1
            fi
          done

          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ Debug APK —á–µ—Ä–µ–∑ Flutter..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º flutter build apk –≤–º–µ—Å—Ç–æ gradlew
          # Debug APK –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –ª–µ–≥–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
          echo "==================================="
          echo "üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
          echo "Flutter version: $(flutter --version | head -1)"
          echo "Dart version: $(dart --version)"
          echo "Java version: $(java -version 2>&1 | head -1)"
          echo "–°–≤–æ–±–æ–¥–Ω–∞—è –ø–∞–º—è—Ç—å: $(free -h | grep Mem)"
          echo "–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ: $(df -h . | tail -1)"
          echo "==================================="

          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —Å –≤—ã–≤–æ–¥–æ–º –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
          echo "–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É APK..."
          flutter build apk --debug --verbose 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}

          echo ""
          echo "==================================="
          echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–±–æ—Ä–∫–∏..."
          echo "==================================="

          # –ò—â–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π APK
          APK_FOUND=""
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            APK_FOUND="build/app/outputs/flutter-apk/app-debug.apk"
            echo "‚úÖ APK –Ω–∞–π–¥–µ–Ω: $APK_FOUND"
            ls -lh "$APK_FOUND"
          elif find build -name "*.apk" 2>/dev/null | grep -q apk; then
            APK_FOUND=$(find build -name "*.apk" | head -1)
            echo "‚úÖ APK –Ω–∞–π–¥–µ–Ω: $APK_FOUND"
            ls -lh "$APK_FOUND"
          else
            echo "‚ùå APK –ù–ï –ù–ê–ô–î–ï–ù!"
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö build –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:"
            find . -type d -name "build" -o -name "outputs" 2>/dev/null || true
            echo ""
            echo "–ü–æ–∏—Å–∫ APK —Ñ–∞–π–ª–æ–≤:"
            find . -name "*.apk" 2>/dev/null || echo "APK —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          fi

          echo "==================================="

          if [ $BUILD_EXIT_CODE -eq 0 ] && [ -n "$APK_FOUND" ]; then
            echo "‚úÖ LITE APK —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"
          else
            echo "‚ùå –û–®–ò–ë–ö–ê –°–ë–û–†–ö–ò LITE APK"
            echo "Exit code: $BUILD_EXIT_CODE"
            echo "APK found: ${APK_FOUND:-NO}"
            echo ""
            echo "========================================="
            echo "üîç –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ —Å–±–æ—Ä–∫–∏:"
            echo "========================================="
            tail -100 build.log
            echo "========================================="
            echo ""
            echo "üîç –ü–æ–∏—Å–∫ Gradle –æ—à–∏–±–æ–∫:"
            grep -i "FAILURE\|BUILD FAILED\|error:" build.log | tail -30 || echo "Gradle –æ—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            echo "========================================="
            exit 1
          fi

      - name: üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ LITE APK
        id: lite_apk_info
        run: |
          # –ü–æ–∏—Å–∫ LITE APK (flutter build apk —Å–æ–∑–¥–∞—ë—Ç –≤ flutter-apk –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)
          APK_PATH=$(find mobile-app-lite/build/app/outputs/flutter-apk -name "*.apk" 2>/dev/null | head -1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find mobile-app-lite/android/app/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1)
          fi
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find mobile-app-lite/android/app/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå LITE APK –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
            echo "  - mobile-app-lite/build/app/outputs/flutter-apk/"
            echo "  - mobile-app-lite/android/app/build/outputs/apk/debug/"
            echo "  - mobile-app-lite/android/app/build/outputs/apk/release/"
            exit 1
          fi

          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi

          NEW_APK_NAME="data20-mobile-LITE-${VERSION}.apk"
          NEW_APK_PATH="mobile-app-lite/build/app/outputs/flutter-apk/${NEW_APK_NAME}"

          mkdir -p "$(dirname "$NEW_APK_PATH")"
          cp "$APK_PATH" "$NEW_APK_PATH"

          echo "path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          echo "name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          echo "size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "========================================="
          echo "üöÄ LITE APK –≥–æ—Ç–æ–≤!"
          echo "========================================="
          echo "–ò–º—è:    $NEW_APK_NAME"
          echo "–†–∞–∑–º–µ—Ä: $APK_SIZE"
          echo "–ü—É—Ç—å:   $NEW_APK_PATH"
          echo "–í–µ—Ä—Å–∏—è: $VERSION"
          echo "========================================="

      - name: ‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ LITE APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.lite_apk_info.outputs.name }}
          path: ${{ steps.lite_apk_info.outputs.path }}
          retention-days: 90
          if-no-files-found: error

      - name: ‚úÖ –ò—Ç–æ–≥–∏ —Å–±–æ—Ä–∫–∏ LITE
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ –°–±–æ—Ä–∫–∞ LITE APK –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
          echo "========================================="
          echo ""
          echo "üì± APK:    ${{ steps.lite_apk_info.outputs.name }}"
          echo "üì¶ –†–∞–∑–º–µ—Ä: ${{ steps.lite_apk_info.outputs.size }}"
          echo "üè∑Ô∏è –í–µ—Ä—Å–∏—è: ${{ steps.lite_apk_info.outputs.version }}"
          echo ""
          echo "========================================="

  # ========================================
  # JOB 2: –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø (FULL)
  # ========================================
  build-full:
    name: üîß –°–±–æ—Ä–∫–∞ FULL –≤–µ—Ä—Å–∏–∏ (~150 MB)
    runs-on: ubuntu-latest
    # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –æ—Ç–∫–ª—é—á–∏–ª full —Å–±–æ—Ä–∫—É
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.build_full == 'true' }}

    steps:
      - name: üì• Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ü¶ã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (FULL)
        continue-on-error: true
        run: |
          echo "========================================="
          echo "üîß –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø - –°–±–æ—Ä–∫–∞"
          echo "========================================="
          echo "Java:    $(java -version 2>&1 | head -n 1)"
          echo "Flutter: $(flutter --version 2>&1 | head -n 1)"
          echo "Python:  $(python3 --version)"
          echo "Branch:  $(git branch --show-current)"
          echo "Commit:  $(git rev-parse --short HEAD)"
          echo "========================================="

      - name: üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Python tools (FULL)
        run: |
          cd mobile-app
          chmod +x copy-tools-to-python.sh
          ./copy-tools-to-python.sh
          echo "‚úÖ Python tools —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

      - name: üìù –°–æ–∑–¥–∞–Ω–∏–µ local.properties –¥–ª—è Android
        run: |
          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ Flutter SDK
          if [ -n "$FLUTTER_HOME" ]; then
            FLUTTER_ROOT="$FLUTTER_HOME"
          elif command -v flutter &> /dev/null; then
            FLUTTER_ROOT=$(dirname "$(dirname "$(which flutter)")")
          else
            echo "‚ùå –û–®–ò–ë–ö–ê: Flutter SDK –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi

          echo "Flutter SDK: $FLUTTER_ROOT"
          echo "flutter.sdk=$FLUTTER_ROOT" > mobile-app/android/local.properties

          echo "‚úÖ local.properties —Å–æ–∑–¥–∞–Ω"
          cat mobile-app/android/local.properties

      - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (FULL)
        run: |
          cd mobile-app
          echo "üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è FULL..."
          flutter pub get --verbose

          if [ ! -f pubspec.lock ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: pubspec.lock –Ω–µ —Å–æ–∑–¥–∞–Ω"
            exit 1
          fi

          echo "‚úÖ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Flutter –ø—Ä–æ–µ–∫—Ç–∞ (FULL)
        continue-on-error: true
        run: |
          cd mobile-app
          echo "üîç Flutter Doctor (FULL):"
          flutter doctor -v
          echo ""
          echo "Flutter Analyze (FULL):"
          flutter analyze --no-fatal-infos

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–∏ APK (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–ª—é—á–∏)
      - name: üîê –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ keystore (FULL)
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        if: env.KEYSTORE_BASE64 != ''
        run: |
          echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è FULL APK..."
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > mobile-app/android/data20-release-key.jks
          echo "‚úÖ Keystore –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω"

      - name: üîë –°–æ–∑–¥–∞–Ω–∏–µ key.properties (FULL)
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        if: env.KEYSTORE_BASE64 != ''
        run: |
          cat > mobile-app/android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=data20-release-key.jks
          EOF
          echo "‚úÖ key.properties —Å–æ–∑–¥–∞–Ω"

      # –°–±–æ—Ä–∫–∞ FULL APK
      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ FULL APK (Debug)
        id: build_full_apk
        run: |
          cd mobile-app
          echo "========================================="
          echo "üîß –°–±–æ—Ä–∫–∞ –ü–û–õ–ù–û–ô –≤–µ—Ä—Å–∏–∏ APK"
          echo "========================================="

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
          declare -a CHECK_FILES=(
            "pubspec.yaml"
            "android/app/build.gradle"
            "android/local.properties"
          )

          for file in "${CHECK_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
              exit 1
            fi
          done

          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ Debug APK —á–µ—Ä–µ–∑ Flutter..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º flutter build apk –≤–º–µ—Å—Ç–æ gradlew
          # Debug APK –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –ª–µ–≥–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
          echo "==================================="
          echo "üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
          echo "Flutter version: $(flutter --version | head -1)"
          echo "Dart version: $(dart --version)"
          echo "Java version: $(java -version 2>&1 | head -1)"
          echo "–°–≤–æ–±–æ–¥–Ω–∞—è –ø–∞–º—è—Ç—å: $(free -h | grep Mem)"
          echo "–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ: $(df -h . | tail -1)"
          echo "==================================="

          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —Å –≤—ã–≤–æ–¥–æ–º –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
          echo "–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É APK..."
          flutter build apk --debug --verbose 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}

          echo ""
          echo "==================================="
          echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–±–æ—Ä–∫–∏..."
          echo "==================================="

          # –ò—â–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π APK
          APK_FOUND=""
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            APK_FOUND="build/app/outputs/flutter-apk/app-debug.apk"
            echo "‚úÖ APK –Ω–∞–π–¥–µ–Ω: $APK_FOUND"
            ls -lh "$APK_FOUND"
          elif find build -name "*.apk" 2>/dev/null | grep -q apk; then
            APK_FOUND=$(find build -name "*.apk" | head -1)
            echo "‚úÖ APK –Ω–∞–π–¥–µ–Ω: $APK_FOUND"
            ls -lh "$APK_FOUND"
          else
            echo "‚ùå APK –ù–ï –ù–ê–ô–î–ï–ù!"
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö build –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:"
            find . -type d -name "build" -o -name "outputs" 2>/dev/null || true
            echo ""
            echo "–ü–æ–∏—Å–∫ APK —Ñ–∞–π–ª–æ–≤:"
            find . -name "*.apk" 2>/dev/null || echo "APK —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          fi

          echo "==================================="

          if [ $BUILD_EXIT_CODE -eq 0 ] && [ -n "$APK_FOUND" ]; then
            echo "‚úÖ FULL APK —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"
          else
            echo "‚ùå –û–®–ò–ë–ö–ê –°–ë–û–†–ö–ò FULL APK"
            echo "Exit code: $BUILD_EXIT_CODE"
            echo "APK found: ${APK_FOUND:-NO}"
            echo ""
            echo "========================================="
            echo "üîç –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ —Å–±–æ—Ä–∫–∏:"
            echo "========================================="
            tail -100 build.log
            echo "========================================="
            echo ""
            echo "üîç –ü–æ–∏—Å–∫ Gradle –æ—à–∏–±–æ–∫:"
            grep -i "FAILURE\|BUILD FAILED\|error:" build.log | tail -30 || echo "Gradle –æ—à–∏–±–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            echo "========================================="
            exit 1
          fi

      - name: üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ FULL APK
        id: full_apk_info
        run: |
          # –ü–æ–∏—Å–∫ FULL APK (flutter build apk —Å–æ–∑–¥–∞—ë—Ç –≤ flutter-apk –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)
          APK_PATH=$(find mobile-app/build/app/outputs/flutter-apk -name "*.apk" 2>/dev/null | head -1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find mobile-app/android/app/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1)
          fi
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find mobile-app/android/app/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå FULL APK –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
            echo "  - mobile-app/build/app/outputs/flutter-apk/"
            echo "  - mobile-app/android/app/build/outputs/apk/debug/"
            echo "  - mobile-app/android/app/build/outputs/apk/release/"
            exit 1
          fi

          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi

          NEW_APK_NAME="data20-mobile-FULL-${VERSION}.apk"
          NEW_APK_PATH="mobile-app/build/app/outputs/flutter-apk/${NEW_APK_NAME}"

          mkdir -p "$(dirname "$NEW_APK_PATH")"
          cp "$APK_PATH" "$NEW_APK_PATH"

          echo "path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          echo "name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          echo "size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "========================================="
          echo "üîß FULL APK –≥–æ—Ç–æ–≤!"
          echo "========================================="
          echo "–ò–º—è:    $NEW_APK_NAME"
          echo "–†–∞–∑–º–µ—Ä: $APK_SIZE"
          echo "–ü—É—Ç—å:   $NEW_APK_PATH"
          echo "–í–µ—Ä—Å–∏—è: $VERSION"
          echo "========================================="

      - name: ‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ FULL APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.full_apk_info.outputs.name }}
          path: ${{ steps.full_apk_info.outputs.path }}
          retention-days: 90
          if-no-files-found: error

      - name: ‚úÖ –ò—Ç–æ–≥–∏ —Å–±–æ—Ä–∫–∏ FULL
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ –°–±–æ—Ä–∫–∞ FULL APK –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
          echo "========================================="
          echo ""
          echo "üì± APK:    ${{ steps.full_apk_info.outputs.name }}"
          echo "üì¶ –†–∞–∑–º–µ—Ä: ${{ steps.full_apk_info.outputs.size }}"
          echo "üè∑Ô∏è –í–µ—Ä—Å–∏—è: ${{ steps.full_apk_info.outputs.version }}"
          echo ""
          echo "========================================="

  # ========================================
  # JOB 3: –ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢
  # ========================================
  summary:
    name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç
    runs-on: ubuntu-latest
    needs: [build-lite, build-full]
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–Ω–∞ –∏–∑ —Å–±–æ—Ä–æ–∫ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å
    if: always()

    steps:
      - name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç –æ —Å–±–æ—Ä–∫–µ
        run: |
          echo ""
          echo "========================================="
          echo "üìä –ò–¢–û–ì–ò –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û–ô –°–ë–û–†–ö–ò"
          echo "========================================="
          echo ""
          echo "üöÄ LITE –≤–µ—Ä—Å–∏—è: ${{ needs.build-lite.result }}"
          echo "üîß FULL –≤–µ—Ä—Å–∏—è: ${{ needs.build-full.result }}"
          echo ""
          echo "========================================="
          echo "üì• –°–∫–∞—á–∞—Ç—å APK –º–æ–∂–Ω–æ –∏–∑:"
          echo "  üîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "========================================="
          echo ""

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–±–µ–∏—Ö —Å–±–æ—Ä–æ–∫
          if [ "${{ needs.build-lite.result }}" == "success" ] && [ "${{ needs.build-full.result }}" == "success" ]; then
            echo "‚úÖ –û–ë–ï –í–ï–†–°–ò–ò –°–û–ë–†–ê–ù–´ –£–°–ü–ï–®–ù–û!"
            exit 0
          elif [ "${{ needs.build-lite.result }}" == "success" ] || [ "${{ needs.build-full.result }}" == "success" ]; then
            echo "‚ö†Ô∏è –û–î–ù–ê –ò–ó –í–ï–†–°–ò–ô –ù–ï –°–û–ë–†–ê–õ–ê–°–¨"
            exit 0
          else
            echo "‚ùå –û–ë–ï –í–ï–†–°–ò–ò –ù–ï –°–û–ë–†–ê–õ–ò–°–¨"
            exit 1
          fi
# Trigger build
