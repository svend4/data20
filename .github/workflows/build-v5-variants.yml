name: üì± –°–±–æ—Ä–∫–∞ v5-full - –í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (Lite, Standard, Full)

on:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–∏ push –≤ –≤–µ—Ç–∫–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ v5-full
  push:
    branches:
      - main
      - master
      - 'claude/**'
    paths:
      - 'mobile-app-versions/v5-full/**'
      - 'mobile-app/BUILD_VARIANTS.md'
      - '.github/workflows/build-v5-variants.yml'

  # –°–±–æ—Ä–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ release
  release:
    types: [created, published]

  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI
  workflow_dispatch:
    inputs:
      version:
        description: '–í–µ—Ä—Å–∏—è APK (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.0.0)'
        required: false
        default: 'dev'
      build_lite:
        description: '–°–æ–±—Ä–∞—Ç—å LITE –≤–∞—Ä–∏–∞–Ω—Ç (45 MB, 12 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)?'
        required: false
        type: boolean
        default: true
      build_standard:
        description: '–°–æ–±—Ä–∞—Ç—å STANDARD –≤–∞—Ä–∏–∞–Ω—Ç (65 MB, 35 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)?'
        required: false
        type: boolean
        default: true
      build_full:
        description: '–°–æ–±—Ä–∞—Ç—å FULL –≤–∞—Ä–∏–∞–Ω—Ç (95 MB, 57 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)?'
        required: false
        type: boolean
        default: true

env:
  FLUTTER_VERSION: '3.16.0'
  JAVA_VERSION: '17'
  PYTHON_VERSION: '3.9'
  WORKING_DIR: 'mobile-app-versions/v5-full'

jobs:
  # ========================================
  # JOB 1: LITE VARIANT (45 MB, 12 tools)
  # ========================================
  build-lite-variant:
    name: ‚ö° Lite Variant (45 MB, 12 tools)
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.build_lite == 'true' }}
    timeout-minutes: 45

    steps:
      - name: üì• Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ü¶ã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (LITE)
        run: |
          echo "========================================="
          echo "‚ö° LITE VARIANT - 45 MB, 12 tools"
          echo "========================================="
          echo "Java:    $(java -version 2>&1 | head -n 1)"
          echo "Flutter: $(flutter --version 2>&1 | head -n 1)"
          echo "Python:  $(python3 --version)"
          echo "Branch:  $(git branch --show-current || echo 'detached')"
          echo "Commit:  $(git rev-parse --short HEAD)"
          echo "Working directory: ${{ env.WORKING_DIR }}"
          echo "========================================="

      - name: üìù –°–æ–∑–¥–∞–Ω–∏–µ local.properties
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          FLUTTER_ROOT=$(dirname "$(dirname "$(which flutter)")")
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "flutter.sdk=$FLUTTER_ROOT" >> android/local.properties
          cat android/local.properties

      - name: üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Flutter
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub get
          flutter pub upgrade --major-versions

      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ APK - LITE –≤–∞—Ä–∏–∞–Ω—Ç
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ LITE –≤–∞—Ä–∏–∞–Ω—Ç–∞..."
          flutter build apk \
            --flavor lite \
            --release \
            --dart-define=APP_VARIANT=lite \
            --split-per-abi

      - name: üìè –†–∞–∑–º–µ—Ä APK (LITE)
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "========================================="
          echo "üìè –†–∞–∑–º–µ—Ä—ã LITE APK:"
          echo "========================================="
          cd build/app/outputs/flutter-apk
          ls -lh app-lite-release*.apk | awk '{print $9, "-", $5}'
          echo "========================================="

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK - LITE (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: data20-lite-arm64-v8a
          path: ${{ env.WORKING_DIR }}/build/app/outputs/flutter-apk/app-lite-release-arm64-v8a.apk
          retention-days: 90

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK - LITE (armeabi-v7a)
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: data20-lite-armeabi-v7a
          path: ${{ env.WORKING_DIR }}/build/app/outputs/flutter-apk/app-lite-release-armeabi-v7a.apk
          retention-days: 90

      - name: ‚úÖ LITE –≤–∞—Ä–∏–∞–Ω—Ç –≥–æ—Ç–æ–≤
        run: |
          echo "========================================="
          echo "‚úÖ LITE –≤–∞—Ä–∏–∞–Ω—Ç —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üì¶ Package: com.data20.mobile_app.lite"
          echo "üìè –†–∞–∑–º–µ—Ä: ~45 MB"
          echo "üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: 12"
          echo "========================================="

  # ========================================
  # JOB 2: STANDARD VARIANT (65 MB, 35 tools)
  # ========================================
  build-standard-variant:
    name: ‚≠ê Standard Variant (65 MB, 35 tools)
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.build_standard == 'true' }}
    timeout-minutes: 50

    steps:
      - name: üì• Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ü¶ã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (STANDARD)
        run: |
          echo "========================================="
          echo "‚≠ê STANDARD VARIANT - 65 MB, 35 tools"
          echo "========================================="
          echo "Java:    $(java -version 2>&1 | head -n 1)"
          echo "Flutter: $(flutter --version 2>&1 | head -n 1)"
          echo "Python:  $(python3 --version)"
          echo "Branch:  $(git branch --show-current || echo 'detached')"
          echo "Commit:  $(git rev-parse --short HEAD)"
          echo "Working directory: ${{ env.WORKING_DIR }}"
          echo "========================================="

      - name: üìù –°–æ–∑–¥–∞–Ω–∏–µ local.properties
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          FLUTTER_ROOT=$(dirname "$(dirname "$(which flutter)")")
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "flutter.sdk=$FLUTTER_ROOT" >> android/local.properties
          cat android/local.properties

      - name: üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Flutter
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub get
          flutter pub upgrade --major-versions

      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ APK - STANDARD –≤–∞—Ä–∏–∞–Ω—Ç
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ STANDARD –≤–∞—Ä–∏–∞–Ω—Ç–∞..."
          flutter build apk \
            --flavor standard \
            --release \
            --dart-define=APP_VARIANT=standard \
            --split-per-abi

      - name: üìè –†–∞–∑–º–µ—Ä APK (STANDARD)
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "========================================="
          echo "üìè –†–∞–∑–º–µ—Ä—ã STANDARD APK:"
          echo "========================================="
          cd build/app/outputs/flutter-apk
          ls -lh app-standard-release*.apk | awk '{print $9, "-", $5}'
          echo "========================================="

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK - STANDARD (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: data20-standard-arm64-v8a
          path: ${{ env.WORKING_DIR }}/build/app/outputs/flutter-apk/app-standard-release-arm64-v8a.apk
          retention-days: 90

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK - STANDARD (armeabi-v7a)
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: data20-standard-armeabi-v7a
          path: ${{ env.WORKING_DIR }}/build/app/outputs/flutter-apk/app-standard-release-armeabi-v7a.apk
          retention-days: 90

      - name: ‚úÖ STANDARD –≤–∞—Ä–∏–∞–Ω—Ç –≥–æ—Ç–æ–≤
        run: |
          echo "========================================="
          echo "‚úÖ STANDARD –≤–∞—Ä–∏–∞–Ω—Ç —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üì¶ Package: com.data20.mobile_app.standard"
          echo "üìè –†–∞–∑–º–µ—Ä: ~65 MB"
          echo "üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: 35"
          echo "========================================="

  # ========================================
  # JOB 3: FULL VARIANT (95 MB, 57 tools)
  # ========================================
  build-full-variant:
    name: üíé Full Variant (95 MB, 57 tools)
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.build_full == 'true' }}
    timeout-minutes: 60

    steps:
      - name: üì• Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ü¶ã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (FULL)
        run: |
          echo "========================================="
          echo "üíé FULL VARIANT - 95 MB, 57 tools"
          echo "========================================="
          echo "Java:    $(java -version 2>&1 | head -n 1)"
          echo "Flutter: $(flutter --version 2>&1 | head -n 1)"
          echo "Python:  $(python3 --version)"
          echo "Branch:  $(git branch --show-current || echo 'detached')"
          echo "Commit:  $(git rev-parse --short HEAD)"
          echo "Working directory: ${{ env.WORKING_DIR }}"
          echo "========================================="

      - name: üìù –°–æ–∑–¥–∞–Ω–∏–µ local.properties
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          FLUTTER_ROOT=$(dirname "$(dirname "$(which flutter)")")
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "flutter.sdk=$FLUTTER_ROOT" >> android/local.properties
          cat android/local.properties

      - name: üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Flutter
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter pub get
          flutter pub upgrade --major-versions

      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ APK - FULL –≤–∞—Ä–∏–∞–Ω—Ç
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ FULL –≤–∞—Ä–∏–∞–Ω—Ç–∞..."
          flutter build apk \
            --flavor full \
            --release \
            --dart-define=APP_VARIANT=full \
            --split-per-abi

      - name: üìè –†–∞–∑–º–µ—Ä APK (FULL)
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "========================================="
          echo "üìè –†–∞–∑–º–µ—Ä—ã FULL APK:"
          echo "========================================="
          cd build/app/outputs/flutter-apk
          ls -lh app-full-release*.apk | awk '{print $9, "-", $5}'
          echo "========================================="

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK - FULL (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: data20-full-arm64-v8a
          path: ${{ env.WORKING_DIR }}/build/app/outputs/flutter-apk/app-full-release-arm64-v8a.apk
          retention-days: 90

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK - FULL (armeabi-v7a)
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: data20-full-armeabi-v7a
          path: ${{ env.WORKING_DIR }}/build/app/outputs/flutter-apk/app-full-release-armeabi-v7a.apk
          retention-days: 90

      - name: ‚úÖ FULL –≤–∞—Ä–∏–∞–Ω—Ç –≥–æ—Ç–æ–≤
        run: |
          echo "========================================="
          echo "‚úÖ FULL –≤–∞—Ä–∏–∞–Ω—Ç —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üì¶ Package: com.data20.mobile_app"
          echo "üìè –†–∞–∑–º–µ—Ä: ~95 MB"
          echo "üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: 57"
          echo "========================================="

  # ========================================
  # JOB 4: SUMMARY - –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  # ========================================
  build-summary:
    name: üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
    runs-on: ubuntu-latest
    needs: [build-lite-variant, build-standard-variant, build-full-variant]
    if: always()

    steps:
      - name: üìä –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
        run: |
          echo "========================================="
          echo "üì± –°–±–æ—Ä–∫–∞ v5-full - –í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã"
          echo "========================================="
          echo ""
          echo "–°—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏:"
          echo "‚ö° LITE:     ${{ needs.build-lite-variant.result }}"
          echo "‚≠ê STANDARD: ${{ needs.build-standard-variant.result }}"
          echo "üíé FULL:     ${{ needs.build-full-variant.result }}"
          echo ""
          echo "========================================="
          echo "üì¶ –°–æ–±—Ä–∞–Ω–Ω—ã–µ APK –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Artifacts:"
          echo "========================================="
          echo ""
          if [ "${{ needs.build-lite-variant.result }}" == "success" ]; then
            echo "‚úÖ data20-lite-arm64-v8a.apk (~45 MB, 12 tools)"
            echo "‚úÖ data20-lite-armeabi-v7a.apk (~45 MB, 12 tools)"
          fi
          if [ "${{ needs.build-standard-variant.result }}" == "success" ]; then
            echo "‚úÖ data20-standard-arm64-v8a.apk (~65 MB, 35 tools)"
            echo "‚úÖ data20-standard-armeabi-v7a.apk (~65 MB, 35 tools)"
          fi
          if [ "${{ needs.build-full-variant.result }}" == "success" ]; then
            echo "‚úÖ data20-full-arm64-v8a.apk (~95 MB, 57 tools)"
            echo "‚úÖ data20-full-armeabi-v7a.apk (~95 MB, 57 tools)"
          fi
          echo ""
          echo "========================================="
          echo "üì• –°–∫–∞—á–∞—Ç—å: Actions ‚Üí Artifacts (90 –¥–Ω–µ–π)"
          echo "========================================="

      - name: ‚úÖ –í—Å–µ —Å–±–æ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
        if: needs.build-lite-variant.result == 'success' && needs.build-standard-variant.result == 'success' && needs.build-full-variant.result == 'success'
        run: |
          echo "üéâ –í—Å–µ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å–æ–±—Ä–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          echo "‚ö° LITE:     45 MB, 12 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"
          echo "‚≠ê STANDARD: 65 MB, 35 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"
          echo "üíé FULL:     95 MB, 57 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"

      - name: ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–±–æ—Ä–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã
        if: needs.build-lite-variant.result != 'success' || needs.build-standard-variant.result != 'success' || needs.build-full-variant.result != 'success'
        run: |
          echo "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–±–æ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
          exit 1
