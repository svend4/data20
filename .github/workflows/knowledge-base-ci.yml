name: Knowledge Base CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Knowledge Base
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Validate structure
      run: |
        python tools/validate.py

    - name: Check for duplicates
      run: |
        python tools/find_duplicates.py

    - name: Update indexes
      run: |
        python tools/update_indexes.py

    - name: Check for broken links
      run: |
        # Простая проверка битых markdown ссылок
        find knowledge -name "*.md" -exec grep -l "](.*\.md)" {} \; | while read file; do
          echo "Checking links in: $file"
        done

    - name: Generate statistics
      run: |
        echo "## Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- Total articles: $(find knowledge -name "*.md" ! -name "INDEX.md" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Total categories: $(find knowledge -maxdepth 1 -type d | tail -n +2 | wc -l)" >> $GITHUB_STEP_SUMMARY

  lint-markdown:
    name: Lint Markdown Files
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Lint markdown
      uses: nosborn/github-action-markdown-cli@v3.3.0
      with:
        files: knowledge/**/*.md docs/**/*.md
        config_file: .markdownlint.json
        ignore_files: .gitignore

  check-quality:
    name: Check Content Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Check for TODOs
      run: |
        if grep -r "TODO\|FIXME\|XXX" knowledge/ docs/; then
          echo "::warning::Found TODO items in documentation"
        fi

    - name: Check file naming
      run: |
        # Проверка на кириллицу в именах файлов
        if find knowledge -name "*[а-яА-ЯёЁ]*"; then
          echo "::error::Found Cyrillic characters in file names"
          exit 1
        fi

    - name: Check metadata coverage
      run: |
        python -c "
        import os
        import re
        from pathlib import Path

        total = 0
        with_metadata = 0

        for md_file in Path('knowledge').rglob('*.md'):
            if md_file.name == 'INDEX.md':
                continue
            total += 1
            content = md_file.read_text()
            if content.startswith('---'):
                with_metadata += 1

        coverage = (with_metadata / total * 100) if total > 0 else 0
        print(f'Metadata coverage: {coverage:.1f}%')

        if coverage < 80:
            print(f'::warning::Metadata coverage is below 80%')
        "

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [validate, lint-markdown, check-quality]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build static site (optional)
      run: |
        # Здесь можно добавить генерацию статического сайта
        # Например, через Jekyll, Hugo или custom генератор
        echo "Building static site..."

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
