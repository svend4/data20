name: ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ Android APK

on:
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–∏ push –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏
  push:
    branches:
      - main
      - master
      - 'claude/**'
    paths:
      - 'mobile-app/**'
      - '.github/workflows/android-apk-auto-build.yml'

  # –°–±–æ—Ä–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ release
  release:
    types: [created, published]

  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI
  workflow_dispatch:
    inputs:
      version:
        description: '–í–µ—Ä—Å–∏—è APK (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.0.0)'
        required: false
        default: 'dev'
      upload_to_release:
        description: '–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π release?'
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: '3.16.0'
  JAVA_VERSION: '17'
  PYTHON_VERSION: '3.9'

jobs:
  build-apk:
    name: üì¶ –°–±–æ—Ä–∫–∞ APK
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚òï –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ü¶ã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–∫—Ä—É–∂–µ–Ω–∏–∏
        run: |
          echo "==================================="
          echo "üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ"
          echo "==================================="
          echo "Java –≤–µ—Ä—Å–∏—è: $(java -version 2>&1 | head -n 1)"
          echo "Flutter –≤–µ—Ä—Å–∏—è: $(flutter --version | head -n 1)"
          echo "Python –≤–µ—Ä—Å–∏—è: $(python3 --version)"
          echo "Git branch: $(git branch --show-current)"
          echo "Git commit: $(git rev-parse --short HEAD)"
          echo "==================================="

      - name: üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Python tools
        run: |
          cd mobile-app
          chmod +x copy-tools-to-python.sh
          ./copy-tools-to-python.sh
          echo "‚úÖ Python tools —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

      - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          cd mobile-app
          flutter pub get
          echo "‚úÖ Flutter –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Flutter –ø—Ä–æ–µ–∫—Ç–∞
        run: |
          cd mobile-app
          flutter doctor -v
          flutter analyze --no-fatal-infos

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–∏ APK (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–ª—é—á–∏)
      - name: üîê –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        if: env.KEYSTORE_BASE64 != ''
        run: |
          echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–ø–∏—Å–∏ release APK..."
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > mobile-app/android/data20-release-key.jks
          echo "‚úÖ Keystore –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω"

      - name: üîë –°–æ–∑–¥–∞–Ω–∏–µ key.properties
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        if: env.KEYSTORE_BASE64 != ''
        run: |
          cat > mobile-app/android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=data20-release-key.jks
          EOF
          echo "‚úÖ key.properties —Å–æ–∑–¥–∞–Ω"

      # –°–±–æ—Ä–∫–∞ APK
      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ Release APK
        run: |
          cd mobile-app
          echo "üèóÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É APK..."
          flutter build apk --release --verbose
          echo "‚úÖ APK —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"

      - name: üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ APK
        id: apk_info
        run: |
          APK_PATH=$(find mobile-app/build/app/outputs/flutter-apk -name "*.apk" | head -1)
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi

          NEW_APK_NAME="data20-mobile-${VERSION}.apk"
          NEW_APK_PATH="mobile-app/build/app/outputs/flutter-apk/${NEW_APK_NAME}"

          # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º APK
          cp "$APK_PATH" "$NEW_APK_PATH"

          echo "path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          echo "name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          echo "size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "=================================="
          echo "üì± APK –≥–æ—Ç–æ–≤!"
          echo "=================================="
          echo "–ò–º—è: $NEW_APK_NAME"
          echo "–†–∞–∑–º–µ—Ä: $APK_SIZE"
          echo "–ü—É—Ç—å: $NEW_APK_PATH"
          echo "–í–µ—Ä—Å–∏—è: $VERSION"
          echo "=================================="

      # –ó–∞–≥—Ä—É–∑–∫–∞ APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–≤—Å–µ–≥–¥–∞)
      - name: ‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.apk_info.outputs.name }}
          path: ${{ steps.apk_info.outputs.path }}
          retention-days: 90
          if-no-files-found: error

      # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ release (–µ—Å–ª–∏ —ç—Ç–æ release —Å–æ–±—ã—Ç–∏–µ)
      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK –≤ Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.apk_info.outputs.path }}
          tag_name: ${{ github.event.release.tag_name }}
          name: "Data20 Mobile v${{ steps.apk_info.outputs.version }}"
          body: |
            ## üì± Data20 Mobile App - Android

            ### üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞

            1. –°–∫–∞—á–∞–π—Ç–µ APK: `${{ steps.apk_info.outputs.name }}`
            2. –í–∫–ª—é—á–∏—Ç–µ "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Android
            3. –û—Ç–∫—Ä–æ–π—Ç–µ APK —Ñ–∞–π–ª –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

            ### ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

            - ‚úÖ 100% –û—Ñ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç–∞
            - ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Python Backend
            - ‚úÖ 57+ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            - ‚úÖ SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
            - ‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            - ‚úÖ Material Design 3 UI

            ### üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

            - Android 7.0 (API 24) –∏–ª–∏ –≤—ã—à–µ
            - ~150MB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
            - ~300MB RAM

            ### üîê –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            - –õ–æ–≥–∏–Ω: `admin`
            - –ü–∞—Ä–æ–ª—å: `admin`

            **‚ö†Ô∏è –ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞!**

            ### üì¶ –†–∞–∑–º–µ—Ä APK

            - –†–∞–∑–º–µ—Ä: ${{ steps.apk_info.outputs.size }}
            - –í–∫–ª—é—á–∞–µ—Ç: Python 3.9 runtime + FastAPI + –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

            ### üöÄ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

            - –ü–µ—Ä–≤—ã–π —Å—Ç–∞—Ä—Ç –∑–∞–Ω–∏–º–∞–µ—Ç ~5-7 —Å–µ–∫—É–Ω–¥ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Python)
            - Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ `127.0.0.1:8001`
            - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å backend –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π release (–µ—Å–ª–∏ –≤—Ä—É—á–Ω—É—é —É–∫–∞–∑–∞–Ω–æ)
      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π Release
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true'
        run: |
          echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ APK –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π release..."
          gh release upload $(gh release list --limit 1 | cut -f3) \
            "${{ steps.apk_info.outputs.path }}" \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚úÖ –ò—Ç–æ–≥–∏ —Å–±–æ—Ä–∫–∏
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ –°–±–æ—Ä–∫–∞ APK –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
          echo "========================================="
          echo ""
          echo "üì± APK: ${{ steps.apk_info.outputs.name }}"
          echo "üì¶ –†–∞–∑–º–µ—Ä: ${{ steps.apk_info.outputs.size }}"
          echo "üè∑Ô∏è –í–µ—Ä—Å–∏—è: ${{ steps.apk_info.outputs.version }}"
          echo ""
          echo "üì• –°–∫–∞—á–∞—Ç—å –º–æ–∂–Ω–æ –∏–∑:"
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "  üîó Release: ${{ github.event.release.html_url }}"
          else
            echo "  üîó Artifacts: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          echo ""
          echo "========================================="
