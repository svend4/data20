name: ðŸš€ Build Knowledge Base

on:
  push:
    branches:
      - main
      - master
      - claude/*
    paths:
      - 'knowledge/**'
      - 'tools/**'
      - 'scripts/**'
      - '.github/workflows/build-kb.yml'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

# Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ¸
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    name: ðŸ—ï¸ Build Site
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ git log

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
          echo "âœ“ Dependencies installed"

      - name: ðŸ› ï¸ Generate all outputs (Quick mode)
        run: |
          chmod +x scripts/generate_all.sh
          ./scripts/generate_all.sh --quick
        timeout-minutes: 15
        continue-on-error: true  # ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð´Ð°Ð¶Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ… Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… tools

      - name: ðŸŒ Generate static site
        run: |
          chmod +x static_site/site_generator.py
          python3 static_site/site_generator.py
        timeout-minutes: 5

      - name: ðŸ“Š Build summary
        run: |
          echo "### ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated files:**" >> $GITHUB_STEP_SUMMARY
          echo "- HTML: $(find . -maxdepth 1 -name '*.html' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- JSON: $(find . -maxdepth 1 -name '*.json' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- CSV: $(find . -maxdepth 1 -name '*.csv' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- Reports: $(find . -maxdepth 1 -name '*REPORT*.md' | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site:**" >> $GITHUB_STEP_SUMMARY
          echo "- Index: âœ“ static_site/public/index.html" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: static_site/public

  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ðŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ðŸ“ Deployment summary
        run: |
          echo "### ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Visit your Knowledge Base dashboard now! ðŸš€" >> $GITHUB_STEP_SUMMARY

  validate:
    name: âœ… Validate Only (on PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install pyyaml

      - name: âœ… Run validation only
        run: |
          chmod +x scripts/generate_all.sh
          ./scripts/generate_all.sh --validate-only
        timeout-minutes: 10

      - name: ðŸ“Š Validation summary
        run: |
          echo "### âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Validation completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
